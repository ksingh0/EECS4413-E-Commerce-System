<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment</title>
<link rel="stylesheet" href="styles.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src = "notification.js"></script>
</head>
<body>

<header>
    <h1>Payment Page</h1>
</header>
<div id = "notification"></div>
<div class="container">
    <h2>Order Summary</h2>
    <div id="orderInfo">
    	<p id ="itemName"></p>
    	<p id="winningBid"></p>
    	<p id="shipping"></p>
    	<p id="expeditedShipping" style = "display: none;"></p>
    	<p id="totalAmount"></p>
    </div>

    <h2>Billing Information</h2>
    <form id="paymentForm">
        <label>Full Name:</label><input type="text" id="billingName" required><br>
        <label>Address:</label><input type="text" id="billingAddress" required><br>
        <label>City:</label><input type="text" id="city" required><br>
        <label>State/Province:</label><input type="text" id="state" required><br>
        <label>Postal Code:</label><input type="text" id="postalCode" required><br>
        <label>Country:</label><input type="text" id="country" required><br>

        <h2>Card Information</h2>
        <label>Name on Card:</label><input type="text" id="cardHolderName" required><br>
        <label>Card Number:</label><input type="text" id="cardNumber" required><br>
        <label>Card Type:</label>
        <select id="cardType" required>
            <option value="">Select</option>
            <option value="VISA">VISA</option>
            <option value="MASTERCARD">MasterCard</option>
            <option value="AMEX">AMEX</option>
        </select><br>
        <label>Expiry Date (MM/YY):</label><input type="text" id="expiryDate" required><br>

        <button type="submit">Submit Payment</button>
    </form>
    <p id="paymentMessage"></p>
</div>

<footer>
<p>Â© 2025 eCommerce Auction Platform</p>
</footer>

<script>
// Read normal parameters
const params = new URLSearchParams(window.location.search);
const userId = params.get("userId");
const auctionId = params.get("auctionId");

// Read expeditedShipping flag
const expeditedShipping = params.get("expeditedShipping") === "true";
console.log(auctionId, expeditedShipping); //debug

// Constant fee (adjust if needed)
const EXPEDITED_FEE = 15;
document.getElementById("expeditedShipping").style.display = (expeditedShipping ? "block" : "none"); //conditional display
let calculatedAmount = 0;

$(document).ready(function() {

    // Load user info
    $.ajax({
        url: "http://localhost:8080/ecommerce-auction-system/api/users/" + userId,
        type: "GET",
        success: function(user){
            $("#billingName").val(user.firstName + " " + user.lastName);
            $("#billingAddress").val(user.streetNumber + " " + user.streetName);
            $("#city").val(user.city);
            $("#state").val(user.state);
            $("#postalCode").val(user.postalCode);
            $("#country").val(user.country);
        }
    });

    // Load auction info
    $.ajax({
        url: "http://localhost:8080/ecommerce-auction-system/api/auctions/" + auctionId,
        type: "GET",
        success: function(auction){
            // getitem info
		    $.ajax({
		        url: "http://localhost:8080/ecommerce-auction-system/api/item/" + auctionId,
		        type: "GET",
		        success: function(item){
		            // Add expedited shipping cost
		            let expeditedCost = expeditedShipping ? item.expedited_shipping : 0;
		            calculatedAmount += item.shippingCost + expeditedCost;
		            
		            $("#itemName").html("Item: " + item.item_name + "<br>");
		            $("#shipping").html("Shipping: $" + item.shippingCost + "<br>");
		               // Show fee only if selected
		            $("#expeditedShipping").html("Expedited Shipping: +$" + item.expedited_shipping + "<br>");
		        }
		    });
           	// info from auction
            calculatedAmount += auction.highestPrice;
            $("#winningBid").html("Winning Bid: $" + auction.highestPrice + "<br>");
            $("#totalAmount").html("<strong>Total Amount: $" + calculatedAmount + "</strong>");
        }
    });
});

$("#paymentForm").submit(function(e){
    e.preventDefault();

    const paymentData = {
        userId: userId,
        auctionId: auctionId,
        amount: calculatedAmount,

        // Billing fields
        billingName: $("#billingName").val(),
        billingAddress: $("#billingAddress").val(),
        city: $("#city").val(),
        state: $("#state").val(),
        postalCode: $("#postalCode").val(),
        country: $("#country").val(),

        // Card data
        cardHolderName: $("#cardHolderName").val(),
        cardNumber: $("#cardNumber").val(),
        cardType: $("#cardType").val(),
        expiryDate: $("#expiryDate").val(),

        paymentTime: new Date().toISOString(),
        status: "PENDING",

        // Store expedited selection in backend record
        expeditedShipping: expeditedShipping
    };
    console.log(paymentData);

    $.ajax({
        url: "http://localhost:8080/ecommerce-auction-system/api/payment",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(paymentData),
        success: function(result){
            if (result.paymentId) {
                window.location.href = "Receipt.html?paymentId=" + result.paymentId;
            } else {
                $("#paymentMessage").text("Payment submitted, but no ID returned.");
            }
        },
        error: function(err){
            console.log(err);
            $("#paymentMessage").text("Payment failed.");
        }
    });
});
</script>

</body>
</html>
